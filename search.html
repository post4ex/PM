<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Search - Postman OS</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        /* Custom Scrollbar */
        .custom-scrollbar::-webkit-scrollbar { height: 8px; width: 8px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: #f1f1f1; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
        
        /* FAB Styling */
        .fab-container { position: fixed; bottom: 2rem; right: 2rem; z-index: 50; }
        .fab-button {
            width: 3.5rem; height: 3.5rem; border-radius: 50%;
            background-color: #2563eb; color: white;
            display: flex; align-items: center; justify-content: center;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            transition: all 0.3s ease; cursor: pointer; border: none; outline: none;
        }
        .fab-button:hover { background-color: #1d4ed8; transform: scale(1.1) rotate(180deg); }
        .fab-button svg { width: 1.5rem; height: 1.5rem; fill: currentColor; }
    </style>
</head>
<body class="bg-gray-100 min-h-screen flex flex-col">

    <!-- Header -->
    <div id="header-placeholder"></div>

    <main class="w-full flex-grow p-4 sm:p-6 lg:p-8">
        <div class="container mx-auto max-w-7xl">
            <!-- Search Card -->
            <div class="bg-white rounded-xl shadow-lg p-6 mb-6 border border-gray-100">
                <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-6">
                    <div>
                        <h1 class="text-2xl font-bold text-gray-800">Global Search</h1>
                        <p class="text-sm text-gray-500 mt-1">Search across all databases using Schema Mapping.</p>
                    </div>
                    <div id="record-count-badge" class="hidden mt-4 md:mt-0 bg-blue-100 text-blue-800 text-xs font-semibold px-3 py-1 rounded-full">
                        0 Records
                    </div>
                </div>
                
                <!-- Controls -->
                <div class="grid grid-cols-1 md:grid-cols-12 gap-4">
                    <div class="md:col-span-4 lg:col-span-3">
                        <label for="data-source" class="block text-xs font-semibold text-gray-500 uppercase tracking-wider mb-1">Data Source</label>
                        <div class="relative">
                            <select id="data-source" class="block w-full pl-3 pr-10 py-2.5 text-sm border-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 rounded-lg border bg-gray-50 hover:bg-white transition-colors cursor-pointer">
                                <option value="ALL_DATA">All Databases (Global)</option>
                            </select>
                            <div class="pointer-events-none absolute inset-y-0 right-0 flex items-center px-2 text-gray-700">
                                <svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                            </div>
                        </div>
                    </div>
                    <div class="md:col-span-8 lg:col-span-9">
                        <label for="search-query" class="block text-xs font-semibold text-gray-500 uppercase tracking-wider mb-1">Keywords</label>
                        <div class="relative">
                            <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                <svg class="h-5 w-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path></svg>
                            </div>
                            <input type="text" id="search-query" class="block w-full pl-10 pr-3 py-2.5 text-sm border-gray-300 rounded-lg border focus:ring-2 focus:ring-blue-500 focus:border-blue-500 shadow-sm" placeholder="Type to filter results across selected source...">
                        </div>
                    </div>
                </div>
            </div>

            <!-- Results -->
            <div id="results-area" class="bg-white rounded-xl shadow-lg border border-gray-100 overflow-hidden min-h-[300px] relative">
                <div id="empty-state" class="absolute inset-0 flex flex-col items-center justify-center text-gray-400">
                    <svg class="h-16 w-16 mb-4 opacity-50" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path></svg>
                    <p class="text-lg font-medium">Ready to Search</p>
                    <p class="text-sm">Type a keyword to search globally or select a specific list.</p>
                </div>
                <div id="table-wrapper" class="hidden overflow-x-auto custom-scrollbar">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50"><tr id="table-headers"></tr></thead>
                        <tbody id="table-body" class="bg-white divide-y divide-gray-200"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </main>

    <!-- FAB -->
    <div class="fab-container">
        <button id="fab-refresh" class="fab-button" title="Force Refresh Data">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M17.65 6.35C16.2 4.9 14.21 4 12 4c-4.42 0-7.99 3.58-7.99 8s3.57 8 7.99 8c3.73 0 6.84-2.55 7.73-6h-2.08c-.82 2.33-3.04 4-5.65 4-3.31 0-6-2.69-6-6s2.69-6 6-6c1.66 0 3.14.69 4.22 1.78L13 11h7V4l-2.35 2.35z"/></svg>
        </button>
    </div>

    <div id="footer-placeholder"></div>
    <script src="layout.js"></script>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const sourceSelect = document.getElementById('data-source');
            const searchInput = document.getElementById('search-query');
            const resultsArea = document.getElementById('results-area');
            const tableWrapper = document.getElementById('table-wrapper');
            const tableHeaders = document.getElementById('table-headers');
            const tableBody = document.getElementById('table-body');
            const emptyState = document.getElementById('empty-state');
            const badge = document.getElementById('record-count-badge');
            const fabRefresh = document.getElementById('fab-refresh');

            let flattenedDataMap = new Map(); 

            // 1. DATA LOADER VIA SCHEMA
            function loadData() {
                const appDataStr = localStorage.getItem('appData');
                if (!appDataStr) {
                    console.warn("Search: No Data Found");
                    return; 
                }

                try {
                    const rawData = JSON.parse(appDataStr);
                    const dataTree = rawData.data || rawData; 
                    flattenedDataMap.clear();

                    // USE SCHEMA from layout.js
                    if (window.DATA_SCHEMA) {
                        for (const [name, path] of Object.entries(window.DATA_SCHEMA)) {
                            // Traverse: e.g. SHIPMENTS -> ORDERS
                            let pointer = dataTree;
                            let valid = true;
                            for (const step of path) {
                                if (pointer && pointer[step]) pointer = pointer[step];
                                else { valid = false; break; }
                            }
                            
                            if (valid && typeof pointer === 'object') {
                                // pointer is now the Collection (e.g. { "ORD-1": {...}, "ORD-2": {...} })
                                // We convert it to array for search
                                const records = Object.values(pointer);
                                if(records.length > 0) {
                                    // Tag source
                                    records.forEach(r => { if(typeof r === 'object') r._source_ = name; });
                                    flattenedDataMap.set(name, records);
                                }
                            }
                        }
                    } else {
                        // Very basic fallback if schema missing
                        console.error("Search: DATA_SCHEMA missing in layout.js");
                    }
                    
                    populateDropdown();
                } catch (e) {
                    console.error("Search: Parse Error", e);
                }
            }

            // 2. DROPDOWN
            function populateDropdown() {
                const currentSelection = sourceSelect.value;
                sourceSelect.innerHTML = '<option value="ALL_DATA">All Databases (Global)</option>';
                const sortedKeys = Array.from(flattenedDataMap.keys()).sort();
                
                sortedKeys.forEach(key => {
                    const option = document.createElement('option');
                    option.value = key;
                    option.textContent = key;
                    sourceSelect.appendChild(option);
                });

                if (currentSelection && (currentSelection === 'ALL_DATA' || flattenedDataMap.has(currentSelection))) {
                    sourceSelect.value = currentSelection;
                }
            }

            // 3. RENDER
            function renderTable(data) {
                tableHeaders.innerHTML = '';
                tableBody.innerHTML = '';

                if (!data || data.length === 0) {
                    tableWrapper.classList.add('hidden');
                    emptyState.classList.remove('hidden');
                    emptyState.innerHTML = '<p class="text-lg">No Results</p>';
                    badge.classList.add('hidden');
                    return;
                }

                tableWrapper.classList.remove('hidden');
                emptyState.classList.add('hidden');

                // Detect Headers (Union of first few rows)
                let headerSet = new Set();
                const isGlobal = sourceSelect.value === 'ALL_DATA';
                
                data.slice(0, 10).forEach(row => {
                    Object.keys(row).forEach(k => {
                        // Filter out heavy nested objects to keep table clean
                        // Exception: We keep primitives and maybe specific small objects if needed
                        const val = row[k];
                        if (k !== '_source_' && (typeof val !== 'object' || val === null)) {
                            headerSet.add(k);
                        }
                    });
                });
                
                const headers = Array.from(headerSet).sort();

                if (isGlobal) {
                    const th = document.createElement('th');
                    th.className = "px-6 py-3 text-left text-xs font-bold text-blue-600 uppercase bg-blue-50 sticky left-0";
                    th.textContent = "SOURCE";
                    tableHeaders.appendChild(th);
                }

                headers.forEach(h => {
                    const th = document.createElement('th');
                    th.className = "px-6 py-3 text-left text-xs font-bold text-gray-500 uppercase whitespace-nowrap";
                    th.textContent = h.replace(/_/g, ' '); 
                    tableHeaders.appendChild(th);
                });

                const displayLimit = 100; 
                data.slice(0, displayLimit).forEach(row => {
                    const tr = document.createElement('tr');
                    tr.className = "hover:bg-gray-50 transition-colors";
                    
                    if (isGlobal) {
                        const td = document.createElement('td');
                        td.className = "px-6 py-4 whitespace-nowrap text-xs font-bold text-blue-600 sticky left-0 bg-white";
                        td.textContent = row._source_ || '-';
                        tr.appendChild(td);
                    }

                    headers.forEach(h => {
                        const td = document.createElement('td');
                        td.className = "px-6 py-4 whitespace-nowrap text-sm text-gray-700";
                        const val = row[h];
                        td.textContent = val !== null && val !== undefined ? val : '-';
                        tr.appendChild(td);
                    });
                    tableBody.appendChild(tr);
                });

                badge.textContent = `${data.length} Matches`;
                badge.classList.remove('hidden');
            }

            // 4. SEARCH ENGINE
            function performSearch() {
                const term = searchInput.value.toLowerCase().trim();
                const source = sourceSelect.value;

                if (source !== 'ALL_DATA') {
                    const dataset = flattenedDataMap.get(source) || [];
                    if (!term) renderTable(dataset);
                    else {
                        const filtered = dataset.filter(row => 
                            Object.values(row).some(val => 
                                (typeof val === 'string' || typeof val === 'number') && String(val).toLowerCase().includes(term)
                            )
                        );
                        renderTable(filtered);
                    }
                    return;
                }

                if (!term) {
                    tableWrapper.classList.add('hidden');
                    emptyState.classList.remove('hidden');
                    return;
                }

                let globalResults = [];
                for (const [key, dataset] of flattenedDataMap.entries()) {
                    if (globalResults.length >= 200) break;
                    const matches = dataset.filter(row => 
                        Object.values(row).some(val => 
                            (typeof val === 'string' || typeof val === 'number') && String(val).toLowerCase().includes(term)
                        )
                    );
                    globalResults = globalResults.concat(matches);
                }
                renderTable(globalResults);
            }

            // LISTENERS
            sourceSelect.addEventListener('change', performSearch);
            let debounceTimer;
            searchInput.addEventListener('input', () => {
                clearTimeout(debounceTimer);
                debounceTimer = setTimeout(performSearch, 300);
            });
            
            if (fabRefresh) {
                fabRefresh.addEventListener('click', () => {
                    const manualBtn = document.getElementById('manual-refresh-button');
                    if (manualBtn) manualBtn.click();
                    else window.location.reload();
                });
            }

            window.addEventListener('appDataLoaded', loadData);
            window.addEventListener('appDataRefreshed', loadData);

            loadData();
        });
    </script>
</body>
</html>
