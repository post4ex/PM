<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Postman - Find Pin</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    <!-- Load layout.js in head to ensure functions are available for inline scripts -->
    <script src="layout.js"></script>
</head>
<body class="bg-gray-100 min-h-screen flex flex-col">

    <!-- Header Placeholder (Outside container for standalone support) -->
    <div id="header-placeholder"></div>

    <main class="w-full flex-grow p-4 sm:p-8">
        <div class="container">
            <div class="card">
                <h1 class="text-2xl font-bold text-center text-gray-800 mb-6">Pincode Serviceability</h1>
                
                <!-- Search Section -->
                <div class="flex flex-col sm:flex-row items-center gap-4 mb-8">
                    <div class="flex rounded-lg overflow-hidden w-full sm:w-1/3 lg:w-1/4">
                        <button id="pinButton" class="p-3 text-white font-semibold rounded-l-lg transition-colors w-1/2 bg-blue-800 hover:bg-blue-900">Pincode</button>
                        <button id="cityButton" class="p-3 text-gray-700 font-semibold rounded-r-lg transition-colors w-1/2 bg-gray-200 hover:bg-gray-300">City</button>
                    </div>
                    <input type="text" id="pincode-input" placeholder="Enter 6-digit Pincode" maxlength="6" class="flex-1 p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-700 w-full">
                    <button id="pincode-search-button" class="px-6 py-3 bg-blue-800 text-white font-semibold rounded-lg hover:bg-blue-900 transition-colors w-full sm:w-auto">
                        Search
                    </button>
                </div>

                <!-- Results and Messages Section -->
                <div id="loading-indicator" class="hidden text-center text-gray-500 mb-4">
                    <p>Searching for pincode details...</p>
                </div>
                <div id="results-container" class="hidden space-y-4">
                    <!-- Results will be rendered here -->
                </div>
                <div id="message-box" class="hidden p-4 rounded-lg" role="alert">
                    <p id="message-text"></p>
                </div>

                <!-- Inline Services Section Placeholder -->
                <div id="pincode-services-area" class="mt-12"></div>
            </div>

            <!-- Pincode page specific script -->
            <script>
            (function() {
        const pincodeInput = document.getElementById('pincode-input');
        const searchButton = document.getElementById('pincode-search-button');
        const resultsContainer = document.getElementById('results-container');
        const messageBox = document.getElementById('message-box');
        const messageText = document.getElementById('message-text');
        const loadingIndicator = document.getElementById('loading-indicator');
        const servicesContainer = document.getElementById('pincode-services-area');

        let currentSearchType = 'pincode';
        const pinButton = document.getElementById('pinButton');
        const cityButton = document.getElementById('cityButton');

        function updateButtonStyles() {
            if (currentSearchType === 'pincode') {
                pinButton.classList.add('bg-blue-800', 'text-white');
                pinButton.classList.remove('bg-gray-200', 'text-gray-700');
                cityButton.classList.add('bg-gray-200', 'text-gray-700');
                cityButton.classList.remove('bg-blue-800', 'text-white');
                pincodeInput.placeholder = 'Enter 6-digit Pincode';
                pincodeInput.maxLength = 6;
                pincodeInput.oninput = function() { this.value = this.value.replace(/[^0-9]/g, ''); };
            } else {
                cityButton.classList.add('bg-blue-800', 'text-white');
                cityButton.classList.remove('bg-gray-200', 'text-gray-700');
                pinButton.classList.add('bg-gray-200', 'text-gray-700');
                pinButton.classList.remove('bg-blue-800', 'text-white');
                pincodeInput.placeholder = 'Enter City Name';
                pincodeInput.maxLength = 50;
                pincodeInput.oninput = null;
            }
        }

        pinButton.addEventListener('click', () => { currentSearchType = 'pincode'; updateButtonStyles(); });
        cityButton.addEventListener('click', () => { currentSearchType = 'city'; updateButtonStyles(); });
        updateButtonStyles();

        // Load inline services content - wrapped to ensure layout.js is ready
        const initServices = () => {
            if (typeof loadDynamicContent === 'function') {
                loadDynamicContent('services.html', 'pincode-services-area');
            }
        };

        initServices();

        const POSTAL_API_BASE_URL = 'https://api.postalpincode.in/';

        const fetchCourierData = async (query, searchType) => {
            try {
                const result = await callApi('getPincodeData', { 
                    searchType: searchType, 
                    query: query 
                });
                if (result && result.status === 'success') {
                    return result.data;
                }
                return null;
            } catch (error) {
                console.error('Google Apps Script fetch error:', error);
                showMessage('An error occurred while fetching courier data.', 'error');
                return null;
            }
        };

        const fetchPostOfficeData = async (query, type = 'pincode') => {
            try {
                const endpoint = type === 'pincode' ? 'pincode/' : 'postoffice/';
                const response = await fetch(`${POSTAL_API_BASE_URL}${endpoint}${query}`);
                if (!response.ok) return null;
                const data = await response.json();
                if (data && data.length > 0 && data[0].Status === 'Success') {
                    return data[0].PostOffice;
                }
                return null;
            } catch (error) {
                console.error('Postal API fetch error:', error);
                throw new Error('Could not fetch postal data.');
            }
        };

        const handleSearch = async () => {
            const query = pincodeInput.value.trim();
            resultsContainer.innerHTML = '';
            resultsContainer.classList.add('hidden');
            messageBox.classList.add('hidden');

            // Ensure services are visible at the start of a new search
            if (servicesContainer) {
                servicesContainer.classList.remove('hidden');
            }

            if (currentSearchType === 'pincode' && query.length !== 6) {
                showMessage('Please enter a valid 6-digit pincode.', 'error');
                return;
            }
            if (currentSearchType === 'city' && query.length < 3) {
                showMessage('Please enter at least 3 characters for city search.', 'error');
                return;
            }

            loadingIndicator.classList.remove('hidden');

            try {
                const [courierData, postOfficeData] = await Promise.all([
                    fetchCourierData(query, currentSearchType),
                    fetchPostOfficeData(query, currentSearchType)
                ]);

                if (!courierData && !postOfficeData) {
                    showMessage('Pincode not serviceable or invalid. Please check the number and try again.', 'error');
                } else {
                    // Hide services and render results
                    if (servicesContainer) {
                        servicesContainer.classList.add('hidden');
                    }
                    renderResults(query, courierData, postOfficeData);
                }
            } catch (error) {
                console.error('Search error:', error);
                showMessage('An error occurred while fetching data. Please check your network and try again.', 'error');
            } finally {
                loadingIndicator.classList.add('hidden');
            }
        };

        const renderResults = (pincode, courierData, postOffices) => {
            let html = '';

            if (courierData) {
                html += `
                    <div class="p-4 bg-green-50 border border-green-200 rounded-lg">
                        <h2 class="text-xl font-semibold text-gray-800 mb-3">General Courier Serviceability</h2>
                        <div class="grid grid-cols-1 sm:grid-cols-2 gap-x-4 gap-y-2 text-gray-700">
                           <p><strong>Destination:</strong> ${courierData.DestinationName || 'N/A'}</p>
                           <p><strong>State:</strong> ${courierData.StateName || 'N/A'}</p>
                           <p><strong>Zone:</strong> ${courierData.ZONE || 'N/A'}</p>
                           <p><strong>ODA:</strong> ${courierData.ODA || 'N/A'}</p>
                           <p><strong>Express (Dox):</strong> ${courierData['Dox (E)'] || 'N/A'}</p>
                           <p><strong>Parcel AIR (NonDox):</strong> ${courierData['NonDox (A)'] || 'N/A'}</p>
                           <p><strong>Parcel SFC (NonDox):</strong> ${courierData['NonDox (S)'] || 'N/A'}</p>
                           <p><strong>Premium (PRO):</strong> ${courierData['PRO (P)'] || 'N/A'}</p>
                        </div>
                    </div>`;
            }

            if (postOffices && postOffices.length > 0) {
                const firstResult = postOffices[0];
                html += `
                    <div class="p-4 bg-blue-50 border border-blue-200 rounded-lg mt-4">
                        <h2 class="text-xl font-semibold text-gray-800 mb-2">India Post Details for ${currentSearchType === 'pincode' ? 'Pincode: ' + firstResult.Pincode : 'City: ' + pincode}</h2>
                        <p class="text-gray-600"><strong>District:</strong> ${firstResult.District}</p>
                        <p class="text-gray-600"><strong>State:</strong> ${firstResult.State}</p>
                    </div>
                    <h3 class="text-lg font-semibold text-gray-700 pt-4">Available Post Offices:</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        ${postOffices.map(office => `
                            <div class="p-4 border rounded-lg bg-gray-50">
                                <p class="font-semibold text-gray-800">${office.Name}</p>
                                <p class="text-sm text-gray-500">${office.BranchType}</p>
                            </div>
                        `).join('')}
                    </div>`;
            }
            
            resultsContainer.innerHTML = html;
            resultsContainer.classList.remove('hidden');
        };

        const showMessage = (text, type) => {
            messageText.textContent = text;
            messageBox.className = 'p-4 rounded-lg border';
            messageBox.classList.add(
                type === 'error' 
                ? 'bg-red-100 border-red-400 text-red-700' 
                : 'bg-green-100 border-green-400 text-green-700'
            );
            messageBox.classList.remove('hidden');
        };

        searchButton.addEventListener('click', handleSearch);
        pincodeInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                e.preventDefault();
                handleSearch();
            }
        });
            })();
    </script>
        </div>
    </main>

    <!-- Footer Placeholder (Outside container for standalone support) -->
    <div id="footer-placeholder"></div>
</body>
</html>
